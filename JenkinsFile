import com.cloudbees.plugins.credentials.impl.*;
import com.cloudbees.plugins.credentials.*;
import com.cloudbees.plugins.credentials.domains.*;

pipeline 
{
    environment 
    {   
        GIT_CREDENTIALS_ID = "TEST"
		GIT_REPOSITORY = 'https://gitlab.com/Geeks.Microservices/AccessHub.git'		
		CONTAINER_REGISTRY = '669486994886.dkr.ecr.eu-west-1.amazonaws.com'		
		IMAGE = "${CONTAINER_REGISTRY}/${IMAGE}:${BUILD_VERSION}" 
		HUB_SERVICE_URL = "https://hub.app.geeks.ltd"
    }
    agent any
    stages
	{    
	         stage('Prepare credentials') 
            {
                steps
                {
                    script
                        {	
                            
							def git_credentials = (Credentials) new UsernamePasswordCredentialsImpl(CredentialsScope.GLOBAL,GIT_CREDENTIALS_ID, "description", "matt@geeks.ltd.uk", "G!7L@62017")
							SystemCredentialsProvider.getInstance().getStore().removeCredentials(Domain.global(), git_credentials)
                            SystemCredentialsProvider.getInstance().getStore().addCredentials(Domain.global(), git_credentials)
                        }
                }				
            }
            stage('Clone sources') 
            {
                steps
                {
                    script
                        {						
							git credentialsId: GIT_CREDENTIALS_ID,  url: GIT_REPOSITORY
                        }
                }				
            }
			
			stage('Build the source code') 
            {
                steps
                {
                    script
                        {	
                            sh 'docker build -t $IMAGE -f Build.Dockerfile --build-arg BUILD_NUMBER=$BUILD_NUMBER --build-arg HUB_SERVICE_URL=$HUB_SERVICE_URL '
                        }
                }				
            }			

    }                
}

